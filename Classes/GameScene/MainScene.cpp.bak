#include "MainScene.h"
#include "AppMacros.h"
#include "GameDefinition.h"

#if (CC_TARGET_PLATFORM == CC_PLATFORM_ANDROID)
#include "JNIProxy.h"
#endif


MainScene::MainScene()
: tableView(NULL){}
MainScene::~MainScene(){}

/*
 *ç§æœ‰å‡½æ•°
 *åˆå§‹åŒ–å˜é‡?èµ„æºç­?
 */
void MainScene::initVariable()
{


}

bool MainScene::init()
{
	pComponentLayer = NULL;
	pBgLayer = NULL;
	pDlgLayer = NULL;

	pScaleSprite = NULL;
	pSprite = NULL;
	pCtlBtn = NULL;
	pLabel = NULL;

	pFrameCache = NULL;
	pSpriteBatchNode = NULL;
	return BasicScene::init();
}

void MainScene::onEnter()
{
	BasicScene::onEnter();
	initVariable();
	initTableView();

	CCLabelTTF* label = CCLabelTTF::create("Hllo,<font face='HelveticaNeue-CondensedBold' size=60 color='#00CC00'>å…ˆç”Ÿ</font>Morning,<a href='action=show'><font color='#FF00FF'>è¦åƒä»€ä¹?</font>\nDo you eat\or not?</a>\nYour money:<a href='item=ID10086'><font color='#FF0000'>2000</font></a>", "Thonburi", 32);  
	
	label->setPosition(ccp(320,480));
	this->addChild(label);
}

void MainScene::onExit()
{
	BasicScene::onExit();
}

/*
 * ç§æœ‰å‡½æ•°
 * åˆå§‹åŒ–åˆ—è¡¨æ§ä»?
 */
void MainScene::initTableView()
{
	CCSize vSize = CCDirector::sharedDirector()->getVisibleSize();
	tableView = CCTableView::create(this, CCSizeMake(vSize.width,vSize.height));
	tableView->setDirection(kCCScrollViewDirectionVertical);
	tableView->setPosition(CCPointZero);
	tableView->setDelegate(this);
	tableView->setVerticalFillOrder(kCCTableViewFillTopDown);
	this->addChild(tableView,1);
	//tableView->reloadData();
}

unsigned int MainScene::numberOfCellsInTableView(cocos2d::extension::CCTableView *table)
{
	return TableCellNum;
}

/*
 * å¡«å……tableViewæ¯ä¸€è¡?
 * åˆå§‹åŒ–å’Œåˆ·æ–°æ—¶éƒ½ä¼šè°ƒç”¨è¯¥å‡½æ•°
 * åœ¨è¯¥å‡½æ•°ä¸­è®¾ç½®tableCellæ‰€åŒ…å«çš„æ§ä»¶åŠå¸ƒå±€
 * @param table è°ƒç”¨è¯¥å‡½æ•°çš„tableView
 * @param idx æ¯ä¸€ä¸ªtableCellæ‰€åœ¨çš„è¡?ä»?å¼€å§?
*/
CCTableViewCell* MainScene::tableCellAtIndex(cocos2d::extension::CCTableView *table, unsigned int idx)
{
	//åœ¨ç°æœ‰tableViewä¸­æŠ½å–cell
	CCTableViewCell* cell = table->dequeueCell();

	//æ ¼å¼åŒ–æ­¤tableViewæ‰€è¦æ˜¾ç¤ºçš„æ–‡å­—åœ¨é…ç½®æ–‡ä»¶ä¸­å¯¹åº”çš„key
	std::string key;
	char temp[7] = {0};
	sprintf(temp, "title%d", idx);
	key.append(temp);
	if (!cell)
	{
		//å¦‚æœcellæ²¡æœ‰åˆ›å»º,åˆ›å»ºä¸€ä¸ªæ–°çš„cell
		//ç›´æ¥è¿”å›è¯¥cell,ç­‰å¾…ä¸‹ä¸€æ¬¡åˆ·æ–°æ—¶è®¾ç½®å…¶ä¸­çš„æ§ä»?
		cell = new CCTableViewCell();
		cell->autorelease();
	} else 
	{
		//cellå·²åˆ›å»?
		//è·å–cellä¸­çš„labelæ§ä»¶
		pLabel = (CCLabelTTF*)cell->getChildByTag(SCENE_MAIN);
		if (pLabel)
		{
			//labelæ§ä»¶å­˜åœ¨
			//è°ƒç”¨JNIä»£ç†ç±»ä¸­çš„xmlè¯»å–å‡½æ•°è·å–å¯¹åº”çš„æ–‡å­?å¹¶è®¾ç½®è¿›label
#if (CC_TARGET_PLATFORM == CC_PLATFORM_ANDROID)
			pLabel->setString(JNIProxy::getStrFromXml(key).c_str());
#else
			pLabel->setString(titleLabels[idx].c_str());
#endif
			
		}else
		{
			//labelæ§ä»¶ä¸å­˜åœ?
			//åˆ›å»ºä¸€ä¸ªæ–°çš„label,å¹¶åŠ å…¥cell
#if (CC_TARGET_PLATFORM == CC_PLATFORM_ANDROID)
			pLabel = CCLabelTTF::create(JNIProxy::getStrFromXml(key).c_str(),"Arial",TITLE_FONT_SIZE*2.5);
#else
			pLabel = CCLabelTTF::create(titleLabels[idx].c_str(),"Arial",TITLE_FONT_SIZE*2.5);
#endif
			
			pLabel->setPosition(ccp(table->getContentSize().width/2,32));
			pLabel->setTag(SCENE_MAIN);
			cell->addChild(pLabel);
		}
		
	}

	return cell;
}

CCSize MainScene::cellSizeForTable(cocos2d::extension::CCTableView *table)
{
	return CCSizeMake(table->getContentSize().width,84);
}

void MainScene::tableCellHighlight(cocos2d::extension::CCTableView* table, cocos2d::extension::CCTableViewCell* cell)
{
	CCLog("highlight idx: %d",cell->getIdx());
	pLabel = (CCLabelTTF*)cell->getChildByTag(SCENE_MAIN);
	CCArray* array = cell->getChildren();
	if (pLabel)
	{
		pLabel->setScale(2);
	}
}

void MainScene::tableCellUnhighlight(cocos2d::extension::CCTableView* table, cocos2d::extension::CCTableViewCell* cell)
{
	CCLog("unhighlight idx: %d",cell->getIdx());
	pLabel = (CCLabelTTF*)cell->getChildByTag(SCENE_MAIN);
	if (pLabel)
	{
		pLabel->setScale(1);
	}
}

void MainScene::tableCellTouched(cocos2d::extension::CCTableView* table, cocos2d::extension::CCTableViewCell* cell)
{
	CCLog("cell idx: %d",cell->getIdx());
	switch (cell->getIdx())
	{
	case 0:
		break;
	case 1:
		TDSceneManager::sharedSceneManager()->runSceneWithID(SCENE_READ_XML);
		break;
	}
}